"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _mongoose=_interopRequireDefault(require("mongoose")),_Comment=_interopRequireDefault(require("./entity/Comment.js")),_Post=_interopRequireDefault(require("../post/entity/Post.js"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class CommentService{constructor(){}async findAll(a,b){try{const a=await _Comment.default.find().populate("user").populate("post").exec();return b.status(200).json({comments:a})}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}async findLasts(a,b){try{let a=await _Comment.default.find().populate("user").populate("post").exec();return a=a.slice(0,5).reverse(),b.status(200).json({comments:a})}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}async create(a,b){try{const c=new _Comment.default({text:a.body.text,user:a.userId,avatarUrl:a.body.avatarUrl,fullName:a.body.fullName,post:a.body.post});_Post.default.findByIdAndUpdate(a.body.post,{$inc:{commentsCount:1}},(a,c)=>a?b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"}):c?void 0:b.status(404).json({message:"\u0417\u0430\u043F\u0438\u0441\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430"}));const d=await c.save(),e=await _Comment.default.populate(d,{path:"user"});return b.status(200).json({comment:e})}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}async delete(a,b){try{const c=_mongoose.default.Types.ObjectId(a.params.id);_Post.default.findOneAndUpdate(c,{$inc:{commentsCount:-1}},(a,c)=>a?b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"}):c?void 0:b.status(404).json({message:"\u0417\u0430\u043F\u0438\u0441\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430"})),_Comment.default.findOneAndDelete({_id:c},(a,c)=>c?a?b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"}):b.status(200).json({message:"\u041A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0439 \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0443\u0434\u0430\u043B\u0435\u043D"}):b.status(404).json({message:"\u041A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0439 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"}))}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}async update(a,b){try{const c=_mongoose.default.Types.ObjectId(a.body.commentId),d=await _Comment.default.findOneAndUpdate({_id:c},{text:a.body.text},{new:!0}).populate("user").populate("post").exec();return d?b.status(200).json({comment:d}):b.status(404).json({message:"\u041A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0439 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"})}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}}exports.default=CommentService;