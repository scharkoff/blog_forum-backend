"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PostService=void 0;var _mongoose=_interopRequireDefault(require("mongoose")),_Post=_interopRequireDefault(require("./entity/Post.js")),_Comment=_interopRequireDefault(require("../comment/entity/Comment.js")),_sorttypeHandler=_interopRequireDefault(require("./handlers/sorttype.handler.js")),_filterHandler=_interopRequireDefault(require("./handlers/filter.handler.js"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class PostService{constructor(){}async findAll(a,b){try{const a=await _Post.default.find().populate("user").exec();return b.status(200).json({posts:a})}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}async findByPage(a,b){try{const{page:c,pageSize:d,sortType:e,tag:f,searchText:g}=a.query,h=parseInt(d),i="null"===f?null:f,j="null"===g?null:g,k=(0,_sorttypeHandler.default)(e),l=(0,_filterHandler.default)(j,i),m=await _Post.default.countDocuments(l).exec(),n=await _Post.default.find(l).sort(k).populate("user").skip((c-1)*d).limit(h).exec();return b.status(200).json({posts:n,postsCount:m})}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}async findOneById(a,b){try{const c=a.params.id,d=await _Comment.default.find({post:_mongoose.default.Types.ObjectId(c)}).populate("user").populate("post").exec();_Post.default.findOneAndUpdate({_id:_mongoose.default.Types.ObjectId(c)},{$inc:{viewsCount:1},commentsCount:d.length},{returnDocument:"after"},(a,c)=>a?b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"}):c?b.status(200).json({post:c,comments:d}):b.status(404).json({message:"\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430"})).populate("user")}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}async remove(a,b){try{const c=a.params.id;await _Comment.default.find({post:_mongoose.default.Types.ObjectId(c)}).deleteMany().exec(),_Post.default.findOneAndDelete({_id:_mongoose.default.Types.ObjectId(c)},(a,c)=>a?b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"}):c?b.status(200).json({message:"\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0443\u0434\u0430\u043B\u0435\u043D\u0430"}):b.status(404).json({message:"\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430"}))}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}async create(a,b){try{const c=new _Post.default({title:a.body.title,text:a.body.text,imageUrl:a.body.imageUrl,tags:a.body.tags,user:a.userId}),d=await c.save();return b.status(200).json({post:d})}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}async update(a,b){try{const c=a.params.id;return await _Post.default.findOneAndUpdate({_id:_mongoose.default.Types.ObjectId(c)},{title:a.body.title,text:a.body.text,imageUrl:a.body.imageUrl,tags:a.body.tags,user:a.body.user}),b.status(200).json({message:"\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0430"})}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}async getLastTags(a,b){try{const a=await _Post.default.find().exec(),c=a.reverse().map(a=>a.tags).flat().filter(a=>a),d=[...new Set(c)].slice(0,5);return b.status(200).json({lastTags:d})}catch(a){return b.status(500).json({message:"\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A"})}}}exports.PostService=PostService;